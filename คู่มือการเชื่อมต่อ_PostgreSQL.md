# คู่มือการเชื่อมต่อ PostgreSQL

คู่มือนี้อธิบายวิธีการเชื่อมต่อแอปพลิเคชันกับ Supabase PostgreSQL สำหรับการดำเนินการกับฐานข้อมูลทั้งในสภาพแวดล้อมการพัฒนาและในการใช้งานจริง

## ขั้นตอนการเชื่อมต่อ

1. **ตัวแปรสภาพแวดล้อม**: การเชื่อมต่อถูกสร้างขึ้นโดยใช้ตัวแปรสภาพแวดล้อมที่กำหนดไว้ใน `.env.local` หรือตั้งค่าในการกำหนดค่าสภาพแวดล้อมของ Vercel

2. **การเริ่มต้นการเชื่อมต่อฐานข้อมูล**: เมื่อแอปพลิเคชันเริ่มทำงาน ไฟล์ `src/services/vercelDb.ts` จะเริ่มต้นการเชื่อมต่อโดยใช้ `@vercel/postgres`

3. **การตรวจสอบการเชื่อมต่อ**: มีการดำเนินการคิวรีทดสอบเพื่อตรวจสอบว่าการเชื่อมต่อทำงานได้อย่างถูกต้อง

## ตัวแปรสภาพแวดล้อม

ตัวแปรสภาพแวดล้อมต่อไปนี้ใน `.env.local` ถูกใช้สำหรับการเชื่อมต่อ PostgreSQL:

```env
# ยูอาร์แอลฐานข้อมูลสำหรับ Supabase PostgreSQL
POSTGRES_URL="postgres://[username]:[password]@[host]:[port]/[database]?sslmode=require&supa=base-pooler.x"
POSTGRES_PRISMA_URL="postgres://[username]:[password]@[host]:[port]/[database]?sslmode=require&supa=base-pooler.x"
POSTGRES_URL_NON_POOLING="postgres://[username]:[password]@[host]:[port]/[database]?sslmode=require"
POSTGRES_HOST="[hostname]"
POSTGRES_USER="[username]"
POSTGRES_PASSWORD="[password]"
POSTGRES_DATABASE="[database]"

# บังคับโหมดการผลิตเพื่อให้แน่ใจว่าใช้ฐานข้อมูลจริง
NODE_ENV="production"
```

## วิธีที่ Vercel ใช้ตัวแปรเหล่านี้

1. **การโหลดตัวแปรสภาพแวดล้อม**: เมื่อนำไปปรับใช้กับ Vercel แพลตฟอร์มจะโหลดตัวแปรสภาพแวดล้อมเหล่านี้จากการตั้งค่าโครงการของคุณ ในการพัฒนา ตัวแปรเหล่านี้จะถูกโหลดจาก `.env.local`

2. **การบูรณาการ @vercel/postgres**: แพ็คเกจ `@vercel/postgres` จะใช้ `POSTGRES_URL` โดยอัตโนมัติหรือใช้ `POSTGRES_URL_NON_POOLING` เป็นตัวเลือกสำรอง

3. **การรวมการเชื่อมต่อ**: ในการผลิต Vercel ใช้การรวมการเชื่อมต่อเพื่อประสิทธิภาพที่ดีขึ้น สิ่งนี้ถูกกำหนดค่าผ่านสตริงการเชื่อมต่อด้วยจุดสิ้นสุด `pooler.supabase.com`

## การทดสอบการเชื่อมต่อด้วยตนเอง

คุณสามารถทดสอบการเชื่อมต่อฐานข้อมูลโดยรัน:

```javascript
import { sql } from '@vercel/postgres';

async function testConnection() {
  try {
    const result = await sql`SELECT NOW() as current_time`;
    console.log('การเชื่อมต่อสำเร็จ:', result.rows[0]);
    return true;
  } catch (error) {
    console.error('การเชื่อมต่อล้มเหลว:', error);
    return false;
  }
}
```

## การแก้ไขปัญหาการเชื่อมต่อ

หากคุณพบปัญหาการเชื่อมต่อ:

1. **ตรวจสอบตัวแปรสภาพแวดล้อม**: ตรวจสอบให้แน่ใจว่าตัวแปรสภาพแวดล้อม PostgreSQL ทั้งหมดถูกตั้งค่าอย่างถูกต้อง บน Vercel ตรวจสอบตัวแปรสภาพแวดล้อมของโครงการในการตั้งค่า

2. **ตรวจสอบการเข้าถึงเครือข่าย**: ตรวจสอบให้แน่ใจว่าฐานข้อมูล Supabase ของคุณอนุญาตการเชื่อมต่อจาก:
   - IP ท้องถิ่นของคุณระหว่างการพัฒนา
   - ช่วง IP ของ Vercel ในการผลิต (Supabase มักจะอนุญาตสิ่งนี้โดยค่าเริ่มต้น)

3. **ข้อกำหนด SSL**: สตริงการเชื่อมต่อรวมถึง `sslmode=require` ซึ่งต้องการ SSL ตรวจสอบให้แน่ใจว่า SSL เปิดใช้งานบนฐานข้อมูลของคุณ

4. **การดีบักการเชื่อมต่อ**: เพิ่มการบันทึกรายละเอียดมากขึ้นโดยเพิ่มคำสั่ง `console.log` ในฟังก์ชั่น `initPostgresConnection`

## การใช้งานในโค้ดของเรา

ในโค้ดของเรา:

1. การเชื่อมต่อฐานข้อมูลถูกเริ่มต้นใน `src/services/vercelDb.ts`
2. เราใช้ `@vercel/postgres` ซึ่งทำให้การจัดการ PostgreSQL กับ Vercel ง่ายขึ้น
3. เราได้เพิ่มการบันทึกรายละเอียดและการจัดการข้อผิดพลาด
4. เราใช้ตัวแปรสภาพแวดล้อม `NODE_ENV` เพื่อบังคับโหมดการผลิตซึ่งทำให้แน่ใจว่าใช้ฐานข้อมูลจริง

## การตั้งค่าในสภาพแวดล้อมใหม่

เมื่อปรับใช้กับสภาพแวดล้อมใหม่:

1. ตั้งค่าตัวแปรสภาพแวดล้อม PostgreSQL ในการตั้งค่าโครงการ Vercel
2. ใช้คอมโพเนนต์ DbInitializer ในแผงควบคุมผู้ดูแลระบบเพื่อสร้างตารางฐานข้อมูลที่จำเป็น
3. ตรวจสอบว่าการเชื่อมต่อทำงานโดยตรวจสอบบันทึกหรือทดสอบฟังก์ชันการทำงาน

ด้วยการปฏิบัติตามคู่มือนี้ คุณควรมีความเข้าใจที่ดีเกี่ยวกับวิธีที่แอปพลิเคชันเชื่อมต่อกับ Supabase PostgreSQL ผ่านโครงสร้างพื้นฐานของ Vercel
